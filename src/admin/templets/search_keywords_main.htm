<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <title><?php echo Lang('search_keywords_main');?></title>
  <link rel="stylesheet" href="../static/web/css/bootstrap.min.css">
  <link rel="stylesheet" href="../static/web/font/css/font-awesome.min.css">
  <link rel="stylesheet" href="../static/web/css/admin.min.css">
  <?php include_once(DEDEADMIN.'/templets/_widget_lang.htm');?>
  <script src="../static/web/js/jquery.min.js"></script>
  <script src="../static/web/js/bootstrap.bundle.min.js"></script>
  <script src="js/key.js"></script>
  <script src="../static/web/js/webajax.js"></script>
  <script src="js/main.js"></script>
  <style>
  .nnpp{border-bottom:1px solid #545b62;border-top:1px solid #ffffff;border-left:1px solid #ffffff;border-right:1px solid #ffffff;filter:alpha(opacity=50)}
  </style>
    <script>
    var pageno = 1;
    var totalrow = <?php echo $totalRow?>;
    var pagesize = <?php echo $pagesize?>;
    var orderby = '<?php echo $orderby?>';
    //加载列表
    function ReloadPage(ordertype) {
        orderby = ordertype;
        var listArea = $Obj('rslist');
        var errMsg = "<?php echo Lang('search_keywords_err_msg1');?><br>[<a href=\"javascript:ReloadPage('" + ordertype + "')\"><?php echo Lang('search_keywords_err_msg2');?></a>]";
        fetch("search_keywords_main.php?dopost=getlist&pageno=" + pageno + "&orderby=" + ordertype).then(resp=>{
            if (resp.ok) {
                return resp.text()
            }
            throw new Error(errMsg);
        }).then((d)=>{
            listArea.innerHTML = d;
        }).catch((error) => {
            listArea.innerHTML = errMsg;
        });
    }
    //载入指定页的列表
    function LoadPage(npage) {
        pageno = npage;
        ReloadPage(orderby);
        ReloadPageNum(pageno);
    }
    //更新一个关键词
    function UpdateNote(nid) {
        var listArea = $Obj('rslist');
        var kw = $Obj('keyword' + nid).value;
        var kws = $Obj('spwords' + nid).value;
        var ct = $Obj('count' + nid).value;
        var errMsg = "<?php echo Lang('search_keywords_err_msg1');?><br>[<a href=\"javascript:LoadPage('" + pageno + "')\"><?php echo Lang('search_keywords_err_msg2');?></a>]";
        const formData = new FormData()
        formData.append('dopost', 'update');
        formData.append('aid', nid);
        formData.append('keyword', kw);
        formData.append('spwords', kws);
        formData.append('count', ct);
        formData.append('pageno', pageno);
        formData.append('orderby', orderby);
        fetch('search_keywords_main.php', {
            method: 'POST',
            body: formData
        })
        .then(r => {
            if (r.ok) {
                return r.text()
            }
            throw new Error(errMsg);
        })
        .then(d => {
            listArea.innerHTML = d;
        }).catch((error) => {
            $DE('edsta').innerHTML = errMsg;
        });
        ShowMsg('<?php echo Lang("search_keywords_success_update");?>');
        //myajax.SendGet("search_keywords_main.php?dopost=update&aid="+nid+"&keyword="+kw+"&spwords="+kws+"&count="+ct+"&pageno="+pageno);
    }
    //删除关键词
    function DelNote(nid) {
        var listArea = $Obj('rslist');
        totalrow = totalrow - 1;
        var pagenum = Math.ceil(totalrow / pagesize);
        if (pagenum <= pageno) pageno = pagenum;
        var errMsg = "<?php echo Lang('search_keywords_err_msg1');?><br>[<a href=\"javascript:LoadPage('" + pageno + "')\"><?php echo Lang('search_keywords_err_msg2');?></a>]";
        fetch("search_keywords_main.php?dopost=del&aid=" + nid + "&pageno=" + pageno + "&orderby=" + orderby).then(resp=>{
            if (resp.ok) {
                return resp.text()
            }
            throw new Error(errMsg);
        }).then((d)=>{
            listArea.innerHTML = d;
        }).catch((error) => {
            listArea.innerHTML = errMsg;
        });
        ReloadPageNum(pageno);
    }
    //重新加载分页列表
    function ReloadPageNum(startnum) {
        var ListArea = $Obj('pagelist');
        var pagenum = Math.ceil(totalrow / pagesize);
        var listsize = 3;
        var ahtml = "";
        var startloop = 1;
        var endnum = 0;
        ahtml += "<?php echo Lang('total');?>" + totalrow + "<?php echo Lang('record_number');?>" + pagenum + "<?php echo Lang('page');?>";
        if (pageno > 1) ahtml += "<a href='javascript:;' onclick='LoadPage(" + (pageno - 1) + ")'><?php echo Lang('pre_page');?></a> ";
        if (startnum >= pagenum - listsize) {
            startloop = pagenum - (listsize * 2);
            if (startloop < 1) startloop = 1;
            for (i = startloop; i <= pagenum; i++) {
                if (i == pageno) ahtml += i + " ";
                else ahtml += "<a href='javascript:;' onclick='LoadPage(" + i + ")'>[" + i + "]</a> ";
            }
        }
        else if (pagenum < listsize) {
            for (i = 1; i <= pagenum; i++) {
                if (i == pageno) ahtml += i + " ";
                else ahtml += "<a href='javascript:;' onclick='LoadPage(" + i + ")'>[" + i + "]</a> ";
            }
        } else {
            startloop = startnum - listsize;
            if (startloop < 1) { startloop = 1; endnum = startloop + (listsize * 2); }
            else { endnum = startnum + listsize; }
            if (endnum >= pagenum) endnum = pagenum;
            for (i = startloop; i <= endnum; i++) {
                if (i == pageno) ahtml += i + " ";
                else ahtml += "<a href='javascript:;' onclick='LoadPage(" + i + ")'>[" + i + "]</a> ";
            }
        }
        if (pageno < pagenum) ahtml += "<a href='javascript:;' onclick='LoadPage(" + (pageno + 1) + ")'><?php echo Lang('next_page');?></a> ";
          ListArea.innerHTML = ahtml;
    }
    </script>
</head>
<body>
    <div class="main" align="center">
        <table width="98%" cellpadding="1" cellspacing="1" bgcolor="#f8f8f8" class="table maintable mt-3 mb-3">
            <tr>
                <td width="30%"><?php echo Lang('search_keywords_main');?></td>
                <td width="70%" align="right"><button type="button" name="n1" id="n1" class="btn btn-success btn-sm" onClick="location='article_keywords_main.php';"><?php echo Lang('article_keywords_main');?></button></td>
            </tr>
        </table>
        <span id="rslist">
        <?php
        GetKeywordList($dsql,$pageno,$pagesize,$orderby);
        ?>
        </span>
        <table width="98%" cellpadding="1" cellspacing="1" bgcolor="#f8f8f8" class="table maintable mt-3 mb-3">
            <tr>
                <td align="center" colspan="5" bgcolor="#f8f8f8" class="py-2">
                    <span id="pagelist"></span>
                    <script>ReloadPageNum(1);</script>
                </td>
            </tr>
        </table>
    </div>
</body>
</html>