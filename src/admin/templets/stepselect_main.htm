{dede:config.pagesize value='30'/}
<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <title><?php echo Lang('stepselect_main');?></title>
    <link rel="stylesheet" href="../static/web/css/bootstrap.min.css">
    <link rel="stylesheet" href="../static/web/font/css/font-awesome.min.css">
    <link rel="stylesheet" href="../static/web/css/admin.min.css">
    <?php include_once(DEDEADMIN.'/templets/_widget_lang.htm');?>
    <script src="../static/web/js/webajax.js"></script>
    <script src="../static/web/js/jquery.min.js"></script>
    <script src="../static/web/js/bootstrap.bundle.min.js"></script>
    <script src="js/main.js"></script>
    <script>
        var loadhtml = "<center><img src='../static/web/img/load.gif' style='padding:30px'></center>";
        function updateItem(aid) {
            var upenumf = document.getElementById('upenumf');
            upenumf.ename.value = $DE('ename' + aid).value;
            upenumf.disorder.value = $DE('disorder' + aid).value;
            upenumf.aid.value = aid;
            upenumf.submit();
        }
        function GetSelType() {
            var selvalue = $DE('egroup1').options[$DE('egroup1').selectedIndex].value;
            return selvalue;
        }
        function AddType() {
            $DE('edsta').style.display = 'block';
            fetch('stepselect_main.php?action=addnew').then(resp=>{
                if (resp.ok) {
                    return resp.text()
                }
                throw new Error('<?php echo Lang("error_fetch");?>');
            }).then((d)=>{
                $DE('edsta').innerHTML = d;
            }).catch((error) => {
                $DE('edsta').innerHTML = errMsg;
            });
        }
        function AddEnum() {
            var id = GetSelType();
            if (id == 0) {
                ShowMsg("<?php echo Lang('stepselect_err_id_isempty');?>");
                return false;
            }
            fetch('stepselect_main.php?action=addenum&id=' + id).then(resp=>{
                if (resp.ok) {
                    return resp.text()
                }
                throw new Error('<?php echo Lang("error_fetch");?>');
            }).then((d)=>{
                $DE('edsta').innerHTML = d;
            }).catch((error) => {
                $DE('edsta').innerHTML = errMsg;
            });
            $DE('edsta').style.display = 'block';
        }
        function EditType() {
            var id = GetSelType();
            if (id == 0) {
                ShowMsg("<?php echo Lang('stepselect_err_id_isempty');?>");
                return false;
            }
            $DE('edsta').style.display = 'block';
            fetch('stepselect_main.php?action=edit&id=' + id).then(resp=>{
                if (resp.ok) {
                    return resp.text()
                }
                throw new Error('<?php echo Lang("error_fetch");?>');
            }).then((d)=>{
                $DE('edsta').innerHTML = d;
            }).catch((error) => {
                $DE('edsta').innerHTML = errMsg;
            });
        }
        function ViewType() {
            var id = GetSelType();
            if (id == 0) {
                ShowMsg("<?php echo Lang('stepselect_err_id_isempty');?>");
                return false;
            }
            $DE('edsta').style.display = 'block';
            fetch('stepselect_main.php?action=view&id=' + id).then(resp=>{
                if (resp.ok) {
                    return resp.text()
                }
                throw new Error('<?php echo Lang("error_fetch");?>');
            }).then((d)=>{
                $DE('edsta').innerHTML = d;
            }).catch((error) => {
                $DE('edsta').innerHTML = errMsg;
            });
        }
        function DelType() {
            if (window.confirm("<?php echo Lang('stepselect_delete_confirm');?>") == false) return false;
            var id = GetSelType();
            if (id == 0) {
                ShowMsg("<?php echo Lang('stepselect_err_id_isempty');?>");
                return false;
            }
            location.href = 'stepselect_main.php?action=del&id=' + id;
        }
        function CloseTWin() {
            $DE('edsta').innerHTML = loadhtml;
            $DE('edsta').style.display = 'none';
        }
        function ChangePage(sobj) {
            var ntxt = sobj.options[sobj.selectedIndex].text;
            if (sobj.options[sobj.selectedIndex].value == 0) {
                location.href = 'stepselect_main.php';
            } else {
                var ns = ntxt.split('|');
                location.href = 'stepselect_main.php?egroup=' + ns[0];
            }
        }
        function TogSel() {
            var ems = document.getElementsByName('ids[]');
            for (i = 0; i < ems.length; i++) {
                if (ems[i].checked == false) ems[i].checked = true;
                else ems[i].checked = false;
            }
        }
        function DelSel() {
            if (window.confirm("<?php echo Lang('stepselect_delete_confirm');?>")) document.form1.submit();
        }
        function ChangePage2(sobj) {
            var nv = sobj.options[sobj.selectedIndex].value;
            if (sobj.options[sobj.selectedIndex].value == 0) {
                location.href = 'stepselect_main.php?egroup=<?php echo $egroup;?>';
            } else {
                location.href = 'stepselect_main.php?egroup=<?php echo $egroup;?>&topvalue=' + nv;
            }
        }
    </script>
    <style>
li{float:left;padding-right:10px;line-height:26px}
.abt{width:90%;border:1px #ffffff solid}
#edsta{position:absolute;top:70px;left:110px;width:280px;height:200px;background:#f8f8f8;border:1px solid #dedede;display:none;padding:6px}
#edsta div{margin:6px}
    </style>
</head>
<body>
    <div id="edsta">
        <center><img src="../static/web/img/load.gif"></center>
    </div>
    <table width="98%" align="center" cellpadding="3" cellspacing="1" class="table maintable mt-3 mb-3">
        <tr>
            <td bgcolor="#f8f8f8" colspan="6"><?php echo Lang('stepselect_main');?></td>
        </tr>
        <tr>
            <td width="90"><?php echo Lang('stepselect_select_group');?>：</td>
            <td width="270">
                <select name="egroup1" id="egroup1" onChange="ChangePage(this)" style="width:260px">
                    <option value='0'><?php echo Lang('stepselect_allgroup');?></option>
                    <?php
                    $selgroup = '';
                    foreach($etypes as $arr)
                    {
                        $stylecolor = "";
                        if ($arr['issystem']==1) $stylecolor = " style='color:#999999' ";
                        if ($egroup==$arr['egroup']) {
                            $selgroup = $arr['itemname'];
                            echo "<option value='{$arr['id']}' $stylecolor selected='1'>{$arr['egroup']}|{$arr['itemname']}</option>";
                        } else {
                            echo "<option value='{$arr['id']}' $stylecolor>{$arr['egroup']}|{$arr['itemname']}</option>";
                        }
                    }
                    ?>
                </select>
            </td>
            <td colspan="2"><i class="fa fa-question-circle" title="<?php echo Lang('help');?>"></i> <?php echo Lang('stepselect_main_tip');?></td>
            <td colspan="2" align="right">
                <button type="button" name="gedit" id="gedit" class="btn btn-success btn-sm" onClick="EditType()"><?php echo Lang('edit');?></button>
                <button type="button" name="gdel" id="gdel" class="btn btn-success btn-sm" onClick="DelType()"><?php echo Lang('delete');?></button>
                <button type="button" name="gview" id="gview" class="btn btn-success btn-sm" onClick="ViewType()"><?php echo Lang('view');?></button>
                <button type="button" name="addnew" id="addnew" class="btn btn-success btn-sm" onClick="AddType()"><?php echo Lang('stepselect_add');?></button>
                <a href="stepselect_main.php?action=upallcache" class="btn btn-success btn-sm"><?php echo Lang('stepselect_upallcache');?></a>
            </td>
        </tr>
    </table>
    <?php
    if (!empty($egroup))
    {
        $arr = $dsql->GetOne("SELECT * FROM `#@__stepselect` WHERE egroup='{$egroup}'");
        $dsql->Execute('out',"SELECT evalue,ename FROM `#@__sys_enum` WHERE egroup='{$arr['egroup']}' ORDER BY disorder ASC,evalue ASC");
        $options = '';
        while($row1 = $dsql->GetArray('out'))
        {
            if (!preg_match("#\.#", $row1['evalue']))
            {
                $row1['ename'] = ($row1['evalue'] % 500 == 0)? $row1['ename'] : '└─'.$row1['ename'];
                if ($topvalue != $row1['evalue']) $options .= "<option value='{$row1['evalue']}'>{$row1['ename']}</option>";
                else $options .= "<option value='{$row1['evalue']}' selected='selected'>{$row1['ename']}</option>";
            }
        }
        //如果添加3级之类
        if ($topvalue % 500 != 0) $arr['issign'] = 2;
    ?>
    <table width="98%" align="center" cellpadding="3" cellspacing="1" class="table maintable mb-3">
        <tr>
            <td bgcolor="#f8f8f8" colspan="8">
                <span class="float-left"><?php echo $selgroup;?> &gt; <?php echo Lang('stepselect_list_main');?></span>
            </td>
        </tr>
        <tr>
            <td>
                <form action="stepselect_main.php" method="post">
                    <input type="hidden" name="action" value="addenum_save">
                    <input type="hidden" name="issign" value="<?php echo $arr['issign'];?>">
                    <input type="hidden" name="egroup" value="<?php echo $arr['egroup'];?>">
                    <span class="float-left ml-2"><?php echo Lang('stepselect_topvalue');?>：
                        <select name="topvalue" onChange="ChangePage2(this)" style="width:160px">
                            <option value="0"><?php echo $selgroup;?></option>
                            <?php echo $options;?>
                        </select>
                    </span>
                    <span class="float-left ml-2"><?php echo Lang('ename');?>：<input type="text" name="ename" style="width:260px"></span>
                    <span class="float-left ml-2"><button type="submit" name="sb2" class="btn btn-success btn-sm"><?php echo Lang('stepselect_add_type');?></button></span>
                </form>
            </td>
        </tr>
    </table>
    <table width="98%" align="center" cellpadding="3" cellspacing="1" class="table maintable">
        <tr>
            <td bgcolor="#f8f8f8" colspan="8">
                <span class="float-left"><a href="stepselect_main.php"><?php echo Lang('stepselect_list');?></a> &gt; <a href="stepselect_main.php?egroup=<?php echo $egroup;?>"><?php echo $selgroup;?></a> &gt; <?php echo Lang('stepselect_list_son');?></span>
            </td>
        </tr>
        <tr align="center" bgcolor="#f8fcf2">
            <td width="6%"><?php echo Lang('select');?></td>
            <td width="6%">id</td>
            <td width="20%"><?php echo Lang('ename');?></td>
            <td width="20%"><?php echo Lang('egroup');?></td>
            <td width="10%"><?php echo Lang('etype');?></td>
            <td width="10%"><?php echo Lang('evalue');?></td>
            <td width="10%"><?php echo Lang('disorder');?></td>
            <td width="18%"><?php echo Lang('operation');?></td>
        </tr>
        <form action="stepselect_main.php" name="upenumf" method="post" id="upenumf">
            <input type="hidden" name="action" value="upenum">
            <input type="hidden" name="aid" value="">
            <input type="hidden" name="ename" value="">
            <input type="hidden" name="disorder" value="">
        </form>
        <form name="form1" action="stepselect_main.php" method="post">
            <input type="hidden" name="action" value="delenumAllSel">
            {dede:datalist empty='<tr><td colspan="8"><center>~lang:none_result~</center></td></tr>'}
            <tr align="center" onMouseMove="javascript:this.bgColor='#f8fcf2';" onMouseOut="javascript:this.bgColor='#FFFFFF';">
                <td><input type="checkbox" name="ids[]" value="{dede:field.id/}"></td>
                <td>{dede:field.id/}</td>
                <td>
                    <?php 
                    if (!preg_match("#\.#", $fields['evalue']))
                    {
                        if ($fields['evalue']>500 && $fields['evalue']%500 != 0)  $fields['ename'] = " └─".$fields['ename'];
                    } else {
                        $fields['ename'] = " └───".$fields['ename'];
                    }
                    ?>
                    <input type='text' id='ename{dede:field.id/}' value='{dede:field.ename/}' class='abt'>
                </td>
                <td>{dede:field.egroup/}</td>
                <td>
                    <?php
                    if (!preg_match("#\.#", $fields['evalue']))
                    {
                        if ($fields['evalue']>500 && $fields['evalue']%500 != 0)  echo Lang('stepselect_etype_1');
                        else echo Lang('stepselect_etype_2');
                    } else {
                        echo Lang("stepselect_etype_3");
                    }
                    ?>
                </td>
                <td>{dede:field.evalue/}</td>
                <td><input type='text' id='disorder{dede:field.id/}' value='{dede:field.disorder/}' class='abt'></td>
                <td>
                    <?php
                    if (!empty($egroup))
                    {
                    ?>
                    <a href='javascript:updateItem({dede:field.id/});' class='btn btn-success btn-sm'><i class='fa fa-refresh'></i> <?php echo Lang('update');?></a>
                    <a href='stepselect_main.php?action=delenum&id={dede:field.id/}' class='btn btn-success btn-sm'><i class='fa fa-trash'></i> <?php echo Lang('delete');?></a>
                    <?php
                    } else {
                        echo "<a href='stepselect_main.php?egroup={$fields['egroup']}'>".$egroups[$fields['egroup']]."</a>";
                    }
                    ?>
                </td>
            </tr>
            {/dede:datalist}
        </form>
        <tr>
            <td colspan="8">
                <a href="javascript:TogSel();" class="btn btn-success btn-sm"><?php echo Lang('select');?></a>
                <a href="javascript:DelSel();" class="btn btn-success btn-sm"><?php echo Lang('delete');?></a>
            </td>
        </tr>
        <tr>
            <td align="center" colspan="8" bgcolor="#f8f8f8">{dede:pagelist listsize='6'/}</td>
        </tr>
    </table>
    <?php
    } else {
    ?>
    <table width="98%" align="center" cellpadding="3" cellspacing="1" class="table maintable mb-3">
        <tr>
            <td bgcolor="#f8f8f8" colspan="8">
                <span class="float-left"><a href="stepselect_main.php"><?php echo Lang('stepselect_list');?></a></span>
            </td>
        </tr>
        <tr align="center" bgcolor="#f8fcf2">
            <td width="6%"><?php echo Lang('select');?></td>
            <td width="6%">id</td>
            <td width="28%"><?php echo Lang('stepselect_itemname');?></td>
            <td width="10%"><?php echo Lang('stepselect_level');?></td>
            <td width="10%"><?php echo Lang('system');?></td>
            <td width="15%"><?php echo Lang('egroup');?></td>
            <td><?php echo Lang('operation');?></td>
        </tr>
        {dede:datalist}
        <tr align="center" onMouseMove="javascript:this.bgColor='#f8fcf2';" onMouseOut="javascript:this.bgColor='#FFFFFF';">
            <td><input type="checkbox" name="ids[]" value="{dede:field.id/}"></td>
            <td>{dede:field.id/}</td>
            <td><a href="stepselect_main.php?egroup={dede:field.egroup/}">{dede:field.itemname/}</a></td>
            <td>
                <?php
                switch ($fields['issign']) {
                    case 0:
                        echo Lang('stepselect_etype_1');
                        break;
                    case 1:
                        echo Lang('stepselect_etype_2');
                        break;
                    case 2:
                        echo Lang('stepselect_etype_3');
                        break;
                }
                ?>
            </td>
            <td> {dede:field.issystem function="@me==1 ? Lang('yes') : Lang('no')"/} </td>
            <td>{dede:field.egroup/}</td>
            <td>
                <a href="stepselect_main.php?action=upallcache&egroup={dede:field.egroup/}" class="btn btn-success btn-sm"><i class="fa fa-refresh"></i> <?php echo Lang('sys_cache_up');?></a>
                <a href="stepselect_main.php?egroup={dede:field.egroup/}" class="btn btn-success btn-sm"><i class="fa fa-bars-ul"></i> <?php echo Lang('stepselect_son_level');?></a>
            </td>
        </tr>
        {/dede:datalist}
        <tr>
            <td align="center" colspan="8" bgcolor="#f8f8f8" class="py-2">{dede:pagelist listsize='6'/}</td>
        </tr>
    </table>
    <?php }?>
</body>
</html>